---
title: MySQL技术内幕-索引与算法
date: 2022-02-12 13:55:54
tags: 
- MySQL
categories: 
- Notes
keywords:
description: some of my thinks
top_img: 
comments: 
cover: https://ae01.alicdn.com/kf/Ue5889eaf11594a4aabca090c5d5060798.jpg
toc:  
toc_number:
copyright:
mathjax:
katex: 
---

# 索引与算法

索引是应用程序开发的一个重要方面，索引太多，应用程序性能受影响。索引太少，查询性能受影响。如何找到合适的平衡点十分重要。

### 一、InnoDB索引概述

InnoDB支持以下几种常见的索引：

:one:B+树索引

:two:全文索引

:three:哈希索引



我们知道InnoDB的哈希索引式自适应的，会根据表的情况，自动为表生成哈希索引，不能认为进行干扰。

​	B+树索引就是传统意义上的索引。（是目前最常用和最有效的索引）



### 二、数据结构和算法

**一、二叉查找树**

B+树是通过二叉查找树、再由平衡二叉树、B树，演变而来。

​	数据结构的知识在此不做过多介绍

​	如图所示是一个简单的二叉查找树

​		 ![image-20220309163436454](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203091634513.png)

可以看到：左子树的键值总是小于根的键值，右子树的键值总是大于根的键值。

二叉查找树可以任意构造。（效率可能不是最好）

**二、平衡二叉树**

​	为了构造性能最好的二叉查找树，需要这个二叉树是平衡的。

定义：首先符合二叉查找树定义；任何节点的两个子树的高度差不大于1。

同时维护一棵平衡二叉树的开销是很大的（最优），不过平衡二叉树一般用于内存结构对象中，相对开销并不大。

### 三、B+树

随着不断的改进，现在很少使用B树，更多的使用B+树。B+树是由B树和索引顺序访问演变而来的。

​	B+树是位磁盘和其他直接存取辅助设备设计的一种平衡查找树。

一、B+树插入

插入前后必须保证叶子结点的顺序是排序的。同时考虑三种不同情况：

​	![image-20220309164248968](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203091642047.png)



为了保持平衡会采用大量的拆分页操作（磁盘操作），为了减少这种磁盘操作，提供了旋转功能。

注：旋转发生在叶子结点所在页已将满了，左右叶子结点没满的情况下。

**二、B+删除操作**

​	![image-20220309164700281](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203091647369.png)



### 四、B+树索引

B+树在数据库中的实现，具有高扇出性。

​	因此，B+索引一般高度都在2~4层。

B+索引一般可以分成（内部结构都是B+树，叶子结点存储着所有信息）

- 聚集索引
- 辅助索引

**一、聚集索引**

**二、辅助索引**

**三、B+树索引管理**

1、索引管理

**创建和删除使用**：ALTER TABLE;   CREATE/DROP INDEX

用户可以为整个列设置索引也可以为列的开头部分设置索引。

**查看索引信息**：SHOW INDEX

举个例子：

​					<img src="https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203091705616.png" alt="image-20220309170508539" style="zoom:80%;" />

​	具体查询的表项值含义参照下面:

<img src="https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203091704548.png" alt="image-20220309170415446" style="zoom:80%;" />



值得注意的是其中 Cardinality十分重要。优化器根据这个值判断是否使用索引，但是它并不是实时更新的（考虑带来的负载问题）。如果要更新可以使用ANALYZE TABLE 命令。Cardinality的值不是十分准确，只是一个大概的值。

2、FAST Index Creation

​	原本MySQL对于索引的删除更改这类DDL操作的流程十分缓慢，效率并不高。

​	从InnoDB1.0x开始支持FAST Index Creation的索引创建方式（FIC）。

具体流程：

​		对于辅助索引创建，对创建的表加S锁，不需要重建表，速度较之间提高了很多。

​		对于删除辅助索引，InnoDB只需要更新内部视图，并将辅助索引空间标记为可用，删除MySQL内部视图对于该索引的定义。



注：

- FIC 的过程中对表加了S锁，创建过程中只能对表进行读操作。

- FIC 只适用于辅助索引，主键索引的创建和删除还按照原本的重建表的方式。



3、Online DDL 

​	虽然FIC 避免创建临时表，不过会阻塞该表的DML 操作。MySQL5.6开始支持Online DDL。



​	允许辅助索引创建的同时还支持：INSERT 、UPDATE、DELETE等DML操作

​	不仅辅助索引，以下几种DDL 也可以通过在线的方式进行操作:

- 辅助索引的创建和删除
- 改变自增长值
- 添加删除外键约束
- 列的重命名

### 五、Cardinality

​	B+树索引的适用情况是在搜索的字段取值范围很广，并且字段的值几乎没有重复。即：高选择性。这是使用B+树是最合适的。

​	那么如何确定高选择性呢？

​		就要通过字段Cardinality来观察。

Cardinality是一个预估值，并不是准确值。实际应用中Cardinality/n_rows_in_table应该尽可能接近1。

**一、Cardinality统计**

​	Cardinality统计信息的更新会发生在两个操作中：UPDATE 、INSERT。（考虑性能影响，不可能在每一次发生的情况下更新）。

因此更新策略：

​	:100:表中1/16的数据发生了变化。

​    :100:stat_modified_counter > 2 000 000 000

 注：stat_modified_counter 表示变化（不管数据是否发生了真实变化）发生的次数。

​		Cardinality内部是对于8个叶子结点进行采样，得到每个页的不同记录数。根据采样信息计算Cardinality。因此Cardinality的值是随机的，每次可能都不同。

### 六、B+树索引的使用

**一、联合索引**

​	是指对表上多个列进行索引。创建法方法和单个索引相同。

联合索引使用情景：

​	:one:本质上来说，联合索引是B+树。不同的是联合索引的键值数量大于等于2。

​	:two:需要注意的是，查询包含在联合索引中的单个列时，不是总能使用联合索引的。

​								<img src="https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203091840198.png" alt="image-20220309184011150" style="zoom:80%;" />		

​	如图所示，叶子结点的顺序是优先按照第一列的键值顺序排列的，因此第二列的键值不是有序的。因此对于第二列进行查询时不能使用到这个联合索引。



**二、覆盖索引**

​	InnoDB支持覆盖索引（covering index）

​	含义：仅从辅助索引中就可以查询的记录，就不用查询聚集索引的记录。避免了回表的磁盘操作。

​	好处之一是辅助索引不包含整行记录的所有信息，其大小远小于聚集索引，减少IO操作。

​	另一个好处是对于统计操作，可以用到覆盖索引的信息。减少IO操作。

**三、优化器不使用索引的情况**

​	有时候会发生并没有使用索引的情况，而是使用聚集索引，即全表扫描。这样的现象就是索引失效。

这种情况多发生在范围查找，Join操作中。

​	如果因为索引并不能直接查询到结果。导致需要重新进行书签访问整行信息。数据是离散存储的，因此变成了瓷盘上的随机读操作。当数据量很大的时候，优化器优先选择通过聚集索引查找数据。

​	综上所述，对于不能进行索引覆盖的情况下，优化器选择辅助索引的情况是，通过辅助索引查找的数据是少量的。



**四、索引提示**

MySQL支持索引提示，显示得告诉优化器使用哪个索引。

​	以下两种情况可能使用到索引提示：

- MySQL优化器错误选择了索引
- 某个SQL 语句可选择的索引非常多，优化器选择计划执行时间的开销可能大于SQL本身。



### 七、哈希索引

​	哈希索引使用哈希算法进行底层实现。

​	使用情景有自适应哈希索引。

说明：

- DBA 并不能干预自适应哈希索引。

- 哈希索引只能用来搜索等值查询。

- 面对其他查找类型，如范围查找，不能使用哈希索引。

- 可以使用innodb_adaptice_hash_index来启用和禁用此特性，默认是开启。
