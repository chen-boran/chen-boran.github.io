---
title: Redis 复制
date: 2021-11-15 22:12:00
tags:
- Redis
categories:
- Notes
keywords:
description:
top_img:
comments:
cover:	https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203151833185.jpg
toc:
toc_number:
copyright:
copyright_author:
copyright_author_href:
copyright_url:
copyright_info:
mathjax:
katex:
aplayer:
highlight_shrink:
aside: 
---

# 复制

通过SLAVEOF 命令进行复制

 <img src="https://i.loli.net/2021/11/17/81Dy94AgbwFop6B.png" alt="image-20211117210636423" style="zoom:67%;" />

被复制的叫做主服务器，相反，对主服务器进行复制的叫做从服务器

两个服务器经过复制之后数据库状态一致。

Redis2.8 版本前后对于服务器断线重连复制的问题解决方案不同，因此下面分两部分具体讨论。



## 1.旧版复制实现

Redis2.8 版本之前

首先了解一些基本概念 ：

复制分为同步和命令传播

- 同步： 从服务器的数据库状态更新至主服务器当前所处的数据库状态。
- 命令传播： 用于在主服务器的数据库状态修改， 主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态。

### 1.1同步

通过SYNC命令实现

具体步骤如下：

1）从服务器向主服务器发送SYNC命令。

2）主服务器收到命令之后使用BGSAVE生成 RDB文件， 并且使用 缓冲区记录从现在开始执行的所有写命令。

3）当主服务器的BGSAVE命令执行完毕时， 将生成的RDB文件发送给从服务器，从服务器接收并载入这个RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态。

4）主服务器将缓冲区内容发送给从服务器，从服务器进而将自身的数据库状态更新至主服务器数据库当前所处的状态。

<img src="https://i.loli.net/2021/11/17/ATBDEmIwagXUzHu.png" alt="image-20211117202010473" style="zoom:80%;" />

**命令传播**

同步完成之后，主从服务器状态达到一致。主服务器执行相关写命令时这种状态将会被改变。

为了保持状态的一致性，主服务需要对从服务器进行命令传播：即将主服务器执行的命令动态发送给从服务器。

## 2、旧版复制缺陷

通常复制的状态分成两种：初次和复制和断线后重复制

- 初次复制：从服务器之前没有复制过任何主服务器
- 断线后重复制：从服务器复制时，因某些原因断线，重新连接之后复制的问题。

新旧复制在初次复制处理没有太大区别，在断线重复值上面旧版复制效率十分低下。新版进行了解决。

旧版复制断线之后，从服务器重新连接，会重新新进行复制，包括断线状态时，主机进行的新的写操作。断线之前进行定复制操作全部丢弃。

注：SYNC命令是一个非常耗费资源的操作， 会耗费主服务器大量的CPU、内存和磁盘I/O资源，

 耗费主从服务器大量的网络资源。

## 3、新版复制功能

Redis从2.8版本开始，使用PSYNC命令代替SYNC命令来执行复制时的同步操作。

PSYNC命令 分成完整重同步 和部分重同步 

❑ 完整重同步：处理初次复制情况 ，其步骤和SYNC命令相同

❑ 部分重同步：用于处理断线后重复制情况，从服务器如果条件允许，从服务器断线重连，主服务器将连接断开期间执行的写命令发送给从服务器，从服务器 根据这些命令进行状态同步（用来解决旧版重复制是效率低下的问题）

![image-20211117204237041](https://i.loli.net/2021/11/17/GuqR9MIkO674aWK.png)

## 4、部分重同步实现

具体分成以下三个组成部分：

❑主服务器的复制偏移量（replication offset）和从服务器的复制偏移量。

❑主服务器的复制积压缓冲区（replicationbacklog）。

❑服务器的运行ID（run ID）。

**复制偏移量：**主从服务器分别维护的一个状态量，两服务器每次传输一字节数据，复制偏移量都会变化1。对比主从服务器的复制偏移量，程序可以 知道主从服务器是否处于一致状态

**复制积压缓冲区** ：（用于判断进行部分重同步还是完整重同步）

由主服务器维护的一个固定长度（fixed-size）先进先出（FIFO）队列，默认大小为1MB。

- 当主服务器进行命令传播时，不仅会将写命令发送给所有从服务器，还会将写命令入队到复制积压缓冲区中
- 复制缓冲区保存一部分最近传播的命令
- 从服务器重连 ，从服务器通过PSYNC命令将自己的复制偏移量offset发送给主服务器
- 主服务器根据offset进行判断进行何种操作
  - offset偏移量之后的数据 存在于复制积压缓冲区里面， 主服务器将对从服务器执行部分重同步操作
  - offset偏移量之后的数据已经不存在于复制积压缓冲区，那么主服务器将对从服务器执行完整重同步操作。

注：Redis为复制积压缓冲区设置的默认大小为1MB，可以自行调整。

​		复制积压缓冲区的最小大小可以根据公式second*write_size_per_second来估算

**服务器运行ID**：主从服务器都有的六进制字符属性

- 主从服务器初次复制时，主服务器发送自身运行ID 给从服务器进行保存
- 如果断线重连，通过比较运行ID，判断之前连接的服务器是否是同一个
  - 相同，进行复制缓冲区判断，决定是否进行部分重复制
  - 不同，直接进行完整重同步

## 5、PSYNC 的实现

psync的调用方法：

- 从服务器以前没有复制过任何主服务器，或者之前执行过SLAVEOF no one命令（哨兵选举主服务器时的操作）

-  从服务器已经复制过某个主服务器， 从服务器在开始一次新的复制时就将向主服务器发送PSYNC ＜runid＞ ＜offset＞命令

  <!--runid是上一次复制的主服务器的运行ID，而offset则是从服务器当前的复制偏移量-->

主服务器接收psync命令后有三种返回状态：

- 返回+FULLRESYNC ＜runid＞ ＜offset＞：表示执行完整重同步
- 主服务器返回+CONTINUE：主从服务器执行部分重同步，从服务器等待主服务器发送自身缺少的命令数据

- 主服务器返回+CONTINUE： 主服务器的版本低于Redis 2.8，不能识别PSYNC命令，之后从服务器将向主服务器发送SYNC命令，并与主服务器执行完整同步操作。

  图15-12 PSYNC执行完整重同步和部分重同步时可能遇上的情况：

<img src="https://i.loli.net/2021/11/17/aT9PpAujX8l3dh5.png" alt="image-20211117210438067" style="zoom:80%;" />

## 6、复制的实现

下面举例说明 Redis2.8或以上版本的复制功能的 实现步骤。

步骤1：设置主服务器的地址和端口

步骤3：发送PING命令

步骤3：发送PING命令

步骤4：身份验证

 步骤5：发送端口信息

步骤6：同步

步骤7：命令传播

## 7、心跳检测

在命令传播阶段，从服务器默认会以每秒一次的频率，向主服务器发送命令：

![image-20211117210958609](https://i.loli.net/2021/11/17/dwYsgN6SmbBPIvy.png)

有三个作用： ❑检测主从服务器的网络连接状态。

​						❑辅助实现min-slaves选项。

​						❑检测命令丢失。

**检测主从服务器的网络连接状态：**

主从服务器 通过发送和接收REPLCONF ACK命令来检查两者之间的网络连接  主服务器一秒钟之内未收到从服务器 发来的REPLCONF ACK命令，主从服务器之间的网络连接出现了问题

**辅助实现min-slaves选项**：

min-slaves-to-write和min-slaves-max-lag两个选项可以防止主服务器在不安全的情况下执行写命令（在一定的延迟或者从服务器链接数量下，主服务器都可能拒绝写命令）

**检测命令丢失**

通过发送的offset确定两者是否状态一致，命令是否丢失

注：Redis 2.8版本以前的命令丢失，主服务器和从服务器都不会注意到，主服务器更不会向从服务器补发丢失的数据。因此尽量使用2.8或以上版本的Redis
