---
title: MySQL技术内幕-InnDB存储引擎与文件
date: 2022-02-12 13:57:10
tags: 
- MySQL
categories: 
- Notes
keywords:
description: some of my thinks
top_img: 
comments: 
cover: https://ae01.alicdn.com/kf/Ue5889eaf11594a4aabca090c5d5060798.jpg
toc:  
toc_number:
copyright:
mathjax:
katex:
---



## 一、Mysql体系结构和存储引擎

### 1.1 数据库和实例

一、数据库和实例

数据库：**物理**存储文件和其他形式文件类型的集合。（文件的集合，以某种数据模型结构存储在二级存储器中的数据集合）

实例：Mysql是由后台进程和共享内存区构成的，数据库实例是真正用于操作数据库实例的。用户对于数据库的任何操作都是依靠于数据库实例下进行的。

注：

- 通常情况下一个数据库对应一个数据库实例，集群情况下，可能出现一个数据库对应多个数据库实例。
- Mysql数据库被设计成单进程多线程架构的数据库，和SQL server相同。



二、数据库操作

观察数据库进程情况：通过 ps 命令

​	![image-20220307195121263](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203071951341.png)

mysql配置文件：

​	按照/etc/my.cnf  ——>/etc/mysql/my.cnf /——>/usr/local/mysql/etc/my.cnf ——>/.my.cnf

顺序读取

并且以最后读取的数据文件为基准。

### 1.2 数据库体系结构

Mysql由以下几部分组成：

- 连接池组件

- 管理服务和功能组件
- SQL接口组件
- 查询分析器组件
- 优化器组件
- 缓冲组件
- 插件式存储引擎组件
- 物理文件（数据库）

注：MySQL数据库区别于其他数据库的重要特点就是插件式存储引擎，**存储引擎是基于表的，而不是数据库的。**



### 1.3 MySQL存储引擎



MySQL支持多种数据库存储引擎，根据自身需要可以使用预定义的接口灵活地编写存储引擎



一、InnoDB存储引擎

我们重点关注的存储引擎，目前是MySQL的默认存储引擎，设计目标是面向在线事务处理

**特点**：支持外键、支持事务、行锁设计、默认隔离级别是可重复读、通过多版本并发控制来获取更高的并发性、每张表的存储按照逐渐的顺序进行存储、还提供插入缓冲，自适应哈希索引、二次写预读等功能 来提供高可用性和高性能。

从MySQL1.2开始支持全文索引。



二、MyISAM

另外一个重要的存储引擎。

**特点**：不支持事务、表所涉及、支持全文索引，面向一些OLAP数据库应用

他的缓冲池只缓存索引文件，不缓冲数据文件。数据文件的缓冲交由操作系统完成。

存储引擎表由MYD（存放数据文件）和MYI（索引文件）构成



三、其他

​	其他存储引擎在此不做过多介绍，了解即可

​	常见的存储引擎还有：Memory、Archive、Maria、Merge、CSV等



注：

​	MySQL更适合OLTP（联机事务处理）环境，对于ETL（数据抽取存储转换加载）MyISAM更有优势。

### 1.4 各个存储引擎的比较

​	数据库和传统文件系统的重要区别之一就是数据库支持事务。





### 1.5 数据库的连接

​	连接数据库需要连接进程和数据库进程（实例）之间进行通信。

​	常见的通信方式有：管道、命名管道、命名字、TCP\IP套接字、UNIX套接字等



​	数据库进程和连接进程在同一台数据库主机上面的话，可以使用UNIX套接字、命名管道、共享内存的方法。不同主机的数据库连接使用TCP\IP套接字进行连接（通常还会进行用户权限认证）





## 二、存储引擎

### 2.1InnoDB存储引擎

概述：

​		1、InnoDB是事务安全的MySQL存储引擎

​		2、从MySQL5.5开始是默认的表存储引擎

​		3、被设计用来有效的使用内存和CPU

### 2.2 InnoDB版本

MySQL5.1开始允许存储引擎开发商动态方式加载引擎

![image-20220307195451295](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203071954361.png)



### 2.3 体系架构

首先观察下图：

![image-20220307195505494](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203071955565.png)

InnoDB中有很多内存块，组成了大的内存池，负责：

- 维护所有进程和线程访问的内部数据结构
- 重做日志缓冲 
- 缓存磁盘数据，方便快速读取。



后台进程主要用来负责刷新内存池中的数据。

一、后台进程

InnoDB后台是多线程运行的，用来处理不同的任务。

​		1.Master：

​		2.IO：

​		3.Purge Thread



二、内存

InnoDB是按照磁盘进行存储的，记录是按照页的方式进行管理。



**1.缓冲池**

​	简单来说就是一块内存区域，用于缓冲磁盘和内存读取顺序差异。

​	**读取操作**：首先磁盘数据读取到缓冲池，（FIX），下次读取会优先查询并返回缓冲池数据（查询成功即命中）

​	**修改操作**: 首先修改缓冲池中的页数据，再以一定的频率刷新到磁盘上。而非直接的磁盘修改。通过一种 Checkpoint的机制刷新回磁盘。



​	缓冲池中缓存的数据页类型有：索引、数据页、undo页、插入缓冲、自适应哈希索引、锁信息、数据字典信息。

数**据对象如图**：

​	![image-20220307195534647](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203071955740.png)



目前，允许有多个数据库实例，每个页平均分配到不同的缓冲池实例中，减少数据库内部资源竞争，提高并发性。



**2.LRU List\Free List 、Flush List**



用来管理内存区域（缓冲池）

**3.重做日志缓冲**

​	存储引擎首先将重做日志信息放到重做日志缓冲，按照一定的频率刷新到重做日志文件。

​	大致流程：

重做日志缓冲——>一定频率flush ——>重做日志文件（**外部磁盘**）

​	重做日志缓冲的大小通过：innodb_log_buffer_size设置



​	达到以下情况重做日志缓冲将会刷新到外部磁盘的重做日志：

- 后台线程中的Master Thread每一秒进行刷新
- 每个事务提交回进行一次重做日志缓冲刷新
- 重做日志缓冲剩余空间小于1/2时，

**4.额外内存池**

对于内存的管理使用的是一种被称为内存堆的方式进行的。



### 2.4 Checkpoint

之前说过，缓冲区以一定的频率刷新到磁盘。

​	我们知道缓冲池的版本都是比磁盘更新的，为了保证数据因为宕机，异常关机等问题造成丢失的问题，现在数据库系统普遍采用了Write ahead Log 策略：事务提交时先写重做日志，之后再修改页。即使宕机也可以通过重做日志完成数据恢复。

​	CheckPoint目的是解决以下问题：



### 2.5 Master Thread

 

### 2.6 InnoDB关键特性

包括：

​	1、插入缓冲

​	2、二次写

​	3、自适应哈希索引

​	4、异步IO

​	5、刷新临接页

### 2.7 启动、关闭和恢复



## 三、文件

重点分析MyISAm和InnoDB存储引擎的各种文件

包括：

​	1、参数文件

​	2、日志文件

​	3、socket文件

​	4、pid文件

​	5、MySQL表结构文件

​	6、存储引擎文件



### 3.1 参数文件

​	数据库初始化优先读取的一个配置文件，寻找数据库中的各种文件位置，以及某些初始化参数。

​	值得注意的是MySQL实例可以不需要参数文件，这时参数取决于编译时默认的参数和源代码中的默认参数。 

**一、参数？**

​	数据库参数可以看成就是键值对。

查看所有参数：SHOW VARIABLES 命令

**二、参数类型**

​	MySQL中参数大致可以分成两类：

- 动态参数：在数据库实例生命周期内能进行更改的参数

- 静态参数：实例生命周期都不能进行更改，就像是只读的。

  可以通过SET 命令进行更改。

### 3.2 日志文件

日志文件记录了数据库各种类型的活动。

日志文件分为：

- 错误文件
- 二进制文件 
- 慢查询日志
- 查询日志

**一、错误日志**

​	可以通过 SHOW VARIABLES LIKE ‘log_error ’定位错误日志文件。

对于MySQL的启动、运行、关闭过程进行了记录。

**二、慢查询日志**

​	慢查询日志可以帮助DBA 定位可能性存在问题的SQL 语句，从而进行SQL 语句层面的优化。

相关参数：

1. long_query_time 

​	可以设置 long_query_time 参数，使响应时间超过（大于不包含等于）该参数的SQL 语句都加入慢查询日志。（默认值是10秒）。

2. long_queries_not_using_indexexs

   来确定是否使用索引。

   


DBA 可以根据慢查询日志找出有问题的SQL 语句，对其进行优化。

**还可以通过 MySQLdumpslow命令来进行分析**



**三、查询日志**

​	默认文件名：主机名+.log

​	查询日志记录了所有对于Mysql数据库请求的信息（select、show）。甚至对于未能正确执行的SQL 语句，查询日志也会进行记录。

**四、二进制文件日志**

​	记录了所有对于MySQL数据库执行更改的所有操作。（不包括SELECT 和 SHOW 这类命令）

二进制日志还包括了执行数据库更改操作的时间 等额外信息。

​	二进制日志的作用：

- 恢复：数据的恢复：(例如数据库全备文件恢复后，可以使用二进制日志进行point-in-time进行恢复)

- 复制：通过二进制文件的复制和执行使两台数据库进行实时同步

- 审计：用户可以通过二进制文件中的信息来进行审计，判断是否有数据库注入攻击。

  **默认情况下，二进制日志是未启动的。**

**相关参数**：

- max_binlog_size:单个二进制文件的最大值
- binlog_cache_size：二进制文件缓冲的大小（用于保存事务未提交时的所有记录）
- sync_binlog：表示每写入到缓冲 设定的次数之后就同步磁盘。
- binlog-do-db：写入哪些库的日志
- binlog-ignore-db：表示忽略哪些库的日志
- binlog_format：影响二进制文件的格式
- log-slave-update：主从数据库架构时，从数据库不用将二进制日志写入磁盘。（主数据库需要设置该参数）

二进制日志文件是二进制的文件，直接进行查看不会成功（cat，head，tail）。必须使用MySQL提供的工具 **mysqbinlog**进行查看。



### 3.3 套接字文件

​	Mysql连接本地数据库需要使用到UNIX 域套接字文件，一般在/tmp 目录下，名称为 mysql.sock



### 3.4 pid文件

​	Mysql进程实例会有唯一的ID ，该ID 会写入PID 文件 ，并且由参数pid_file 控制，文件名一般为：主机名.pid



### 3.5 表结构定义文件

​	MySQL的存储是按照表结构定义的，每个表可能使用不同的存储引擎，但是都会有以frm结尾的文件。该文件定义表的表结构定义。

​	此外frm文件同时也会存储试图定义。

​	frm文件时文本文件，可以直接通过 cat 命令查看。



### 3.6 InnoDB 存储引擎文件



​	上面的文件都是MySQL 的文件和InnoDB存储引擎无关，下面介绍InnoDB存储引擎文件。

​	这些文件包括重做日志文件、表空间文件。

**一、重做日志文件**

​	重做日志文件至关重要，它记录了对于InnoDB的事务日志。用于解决介质或者实例失败的情况。使用重做日志文件恢复到掉电时刻，保证数据完整性。

​	每个InnoDB存储引擎最少有一个重做日志文件组，包含最少两个重做日志文件。

可以通过参数影响重做日志文件属性：

- innodb_log_file_size：重做日志文件的大小

- innodb_log_files_in_group：重做日志文件组中重做日志文件的数量

- innodb_log_group_home_dir：日志文件所在的路径，默认为 ./

- innodb_mirrored_log_groups：日志镜像文件组的数量（默认为1 ，表示只有一个文件组，没有镜像）

  其中，重做日志文件的大小对于数据库的影响很大。

**重做日志文件和二进制日志有什么区别？**

- **同样都是记录事务日志信息**
- 二进制日志会记录**所有**与Mysql有关的存储引擎有关的 日志信息，而InnoDB重做日志只记录有关该存储引擎的日志信息。
- **记录内容不同**。二进制日志文件记录关于一个事务的具体操作内容；重做日志文件记录每个物理页的更新情况。
- **写入时间不同**。二进制文件写入在事务提交时进行；重做日志文件在事务进行中也会不断写入重做日志文件。



到InnoDB1.2x位置共有51中重做日志文件类型。他们有 基本的格式：

如图所示：

​	![image-20220307195730160](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203071957224.png)

从左到右分别表示：

- 重做日志类型
- 表空间ID
- 页内偏移量
- 重做日志数据部分

**重做日志缓冲写入过程：**

如图所示：

​	![image-20220307195744774](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203071957835.png)

​	写入是按照扇区的大小进行写入的（512字节），因此可以保证写入的成功性，不需要doublewrite。

​	写入方式由：**innodb_flush_log_at_trx_commmit**控制，可以设置成0、1、2

​	0：事务提交时不写入磁盘，等待主线程 每秒刷新。

​	1：执行commit时将缓冲写入磁盘

​	2：重做日志异步写入到磁盘中

通常保证数据库的持久性，必须设置该参数为1。有事务提交就写入重做日志文件。



**二、表空间文件**

​	InnoDB默认把存储的数据按照表空间存放。通常有默认的表空间文件。

​	同样可以通过：innodb_data_file_path来进行设置。

​	所有基于InnoDB的表的数据都会记录到该共享表空间中。

​	可以通过设置：innodb_file_per_table使每个基于InnoDB的表都有独立的表空间，这些**独立的表空间只存储各个表的数据、索引、插入缓冲BITMAP等信息**，其余都存储在默认表空间中。

