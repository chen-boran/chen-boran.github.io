---
title: 操作系统-文件管理
date: 2022-03-14 12:47:48
tags: 
- ["操作系统"]
categories: 
- [Notes]
keywords:
description: some of my thinks
top_img: 
comments: 
cover: https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203151822520.jpg
toc:  
toc_number:
copyright:
mathjax:
katex:
---



### 文件管理



### 一、概述

文件——就是一组有意义的信息/数据集合

文件管理：

重点关注和解决以下问题：

- 计算机中存放了各种各样的文件，一个文件有哪些属性？

- 文件内部的数据应该怎样组织起来？

- 文件之间又应该又应该怎么组织起来？

- 从下往上看，OS应提供哪些功能，才能方便用户、应用程序使用文件？

- 从上往下看，文件数据应该怎么存放在外存（磁盘）上？



文件属性：

常见的文件属性包括：

​	文件名，主要是为了方便用户找到文件，同一目录下不允许有重名文件。

​	标识符：一个系统内的各文件标识符唯一，对用户来说毫无可读性，因此标识符只是操作系统用于区分各个文件的一种内部名称。

​	类型：指明文件的类型

​	位置：文件存放的路径（让用户使用）、在外存中的地址（操作系统使用，对用户不可见）

​	大小：指明文件大小

​	创建时间、上次修改时间

​	文件所有者信息

​	保护信息：对文件进行保护的访问控制信息

重点回顾：

​	![image-20220314164225069](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141642420.png)

### 二、文件逻辑结构

概念：指在用户看来，文件内部的数据应该是如何组织起来的。而“物理结构”指的是在操作系统看来，文件的数据是如何存放在外存中的。

**文件操作的具体实现与文件的逻辑结构、物理结构都有关**

分类：

​	分类标准：是否有结构

​	无结构文件、有结构文件文件

一、无结构文件

​	无结构文件：文件内部的数据就是一系列二进制流或字符流组成。又称“流式文件。

​	因此也不用探讨无结构文件的“逻辑结构”问题。

​	举例：比如 .txt 文件

二、有结构文件

由一组相似的记录组成，又称“记录式文件”。每条记录又若干个数据项组成。如：数据库表文件。



1、定长记录、可变长记录

有结构文件是由一条条记录组成的。通常记录可以分成：定长记录和可变长记录。

​	定长记录：每条记录的长度相同。

​	可变长记录：各条记录的长度不确定，不一定是相同的。

2、**有结构文件的逻辑结构**

分类标准： 根据有结构文件中的各条记录在逻辑上如何组织

:one:顺序文件：文件中的记录一个接一个地顺序排列（逻辑上），记录可以是定长的或可变长的。各个记录在物理上可以顺序存储或链式存储。

​	顺序文件的分类如下：

![image-20220314170005560](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141700629.png)

​	一般来说，考试题目中所说的“顺序文件”指的是物理上顺序存储的顺序文件

​	缺点：删除一个记录比较困难。

:two:索引文件：索引文件本身是定长记录的顺序文件。(解决可变长记录文件，顺序查找的问题)

​	索引文件有很快的检索速度，因此主要用于对信息处理的及时性要求比较高的场合

如图：

 	<img src="https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141704354.png" alt="image-20220314170423294" style="zoom:80%;" />

优点：可以使用不同的数据项创建多个索引表。

​			检索速度很快。

:three:索引顺序文件

​	索引顺序文件是索引文件和顺序文件思想的结合。

​	索引顺序文件，会为文件建立一张索引表，但是：并不是每个记录对应一个索引表项，而是**一组**记录对应一个索引表项。

如图：

​		![image-20220314170641899](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141706960.png)

也就是说把相同组的文件索引放到一个新的索引文件中，组成一个顺序文件，由原来的索引文件进行索引。

:four:多级索引顺序文件

为了进一步提高效率，可以为顺序文件建立多级索引表。在此不做过多赘述。



### 三、文件目录

一层一层的文件目录对用户有什么好处？

​    文件组织清晰，易于查找

​    轻松的实现按名存取的目的。

那么文件目录是如何实现的呢？

随着计算机的发展文件目录的结构也在发生着变化。

#### 一、文件控制块

1、首先了解相关概念：文件控制块

​	文件控制块是为了实现目录的关键数据结构。

目录本身就是一种有结构文件，由一条条记录组成。每条记录对应一个在该放在该目录下的文件

目录文件中的一条记录就是一个**文件控制块（FCB）**

2、需要对目录 进行哪些**操作**？

- 搜索：当用户要使用一个文件时，系统要根据文件名搜索目录，找到该文件对应的目录项

- 创建文件：创建一个新文件时，需要在其所属的目录中增加一个目录项

- 删除文件：当删除一个文件时，需要在目录中删除相应的目录项

- 显示目录：用户可以请求显示目录的内容，如显示该目录中的所有文件及相应属性

- 修改目录：某些文件属性保存在目录中，因此这些属性变化时需要修改相应的目录项（如：文

件重命名）



#### **二、目录结构**

:one:**单级目录结构**

​	整个系统中值建立一张目录表

​	不允许文件重名；应用于早期操作系统。

:two:**两级目录结构**

​	到了早期多用户操作系统使用两级目录结构。

​	分为主文件目录（MFD，Master File Directory）和用户文件目录（UFD，User FlieDirectory）。

两级目录结构允许不同用户的文件重名，也可以在目录上实现实现访问限制（检查此时登录

的用户名是否匹配）

​	**缺点**：用户不能对文件进行分类，灵活性不足。

:three:**多级目录结构**

了解几个概念：

​	绝对路径：从根路径出发的路径

​	当前目录：当前所在的那一级目录

​	相对路径：指的是相对于当前目录的路径。

树型目录结构

​		![image-20220314172144652](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141721733.png)

​	如果查找文件时，每次都从根目录开始查找，是很低效的。因此可以设置一个“当前目录”。例如，此时已经打开了“照片”的目录文件，也就是说，这张目录表已调入内存，那么可以把它设置为“当前目录”。当用户想要访问某个文件时，可以使用从当前目录出发的“相对路径” 。 **引入“当前目录”和“相对路径”后，磁盘I/O的次数减少了。这就提升了访问文件的效率。**

缺点：不利于实现 文件的共享

​	树形目录结构可以很方便地对文件进行分类，层次结构清晰，也能够更有效地进行文件的管理和保护。但是，树形结构不便于实现文件的共享。为此，提出了“无环图目录结构”。

 

:four:无环图目录结构

具体思路是：

​	可以用不同的文件名指向同一个文件，甚至可以指向同一个目录（共享同一目录下的所有内容）。需要为每个共享结点设置一个**共享计数器**，用于记录此时有多少个地方在共享该结点。用户提出删除结点的请求时，只是删除该用户的FCB、并使共享计数器减1，并不会直接删除共享结点。只有共享计数器减为0时，才删除结点。

​	因为文件是共享的，因此在共享文件中，一个用户修改了文件数据，那么所有用户都能看到文件变化。



​		![image-20220314172221700](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141722761.png)

#### 三、索引节点

FCB的改进：目录的使用只有文件名匹配之后才会读取其他信息。考虑让目录表“瘦身”来提升效率。

​	因此把目录中除了文件名之外的文件描述信息都放到一个索引节点。

​	![image-20220314173018481](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141730554.png)

当找到文件名对应的目录项时，索引节点才调入内存。

注：存放在外存中的索引结点称为“磁盘索引结点”，当索引结点放入内存后称为“内存索引结点”。相比之下内存索引结点中需要增加一些信息，比如：文件是否被修改、此时有几个进程正在访问该文件等。

### 四、文件的物理结构 %*%

文件数据应该怎样存放在外存中？

文件的物理结构分类

 分类标准：文件分配方式

- 连续分配
- 连接分配
  - 
- 索引分配



一、文件块、磁盘块

操作系统为文件分配存储空间是以快为基本单位的。

类似于内存中的存储，也是分成一个个快/磁盘块

二、连续分配

​	连续分配方式要求每个文件在磁盘上占有一组连续的块。

1、逻辑地址到物理地址的映射？

（逻辑块号，块内地址）——>（物理块号，块内地址）。只需转换块号就行，块内地址保持不变

​	物理块号 = 起始块号 + 逻辑块号

​	当然还要检查是否逻辑块号合法（逻辑块号 ≥ 长度 就不合法）

2、图示：

​		![image-20220314183641193](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141836258.png)

​		分别存放块的起始地址和长度。不被包括的就是空的块

3、优缺点？

​	优点：**支持随机读取和顺序读取**

​				连续分配在顺序读/写的速度最快。

​	缺点：连续分配物理上是连续的，因此想要拓展更改不方便。

​				存储空间利用率低，产生外部碎片。

三、链接分配

​	链接分配采取离散分配的方式，可以为文件分配离散的磁盘块。分为隐式链接和显式链接两种。

:one:显示链接



图示：

​	![image-20220314192635871](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141926941.png)

把用于链接文件各物理块的指针显式地存放在一张表中。即 文件分配表（FAT，File Allocation Table）

​	需要注意的是：一个磁盘仅设置一张FAT。 开机时，将FAT读入内存，并常驻内存。

- 优点：很方便文件拓展，不会有碎片问题，外存利用率高，**支持顺序存储**，并且**支持随机访问**。相比于隐式链接来说，地址转换时不需要访问磁盘，因此文件的访问效率更高。
- 缺点：文件分配表的需要占用一定的存储空间

:two:隐式链接：除文件的最后一个盘块之外，每个盘块中都存有指向下一个盘块的指针。文件目录

包括文件第一块的指针和最后一块的指针。

图示：

​		![image-20220314183941511](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141839578.png)

- 优点：很方便文件拓展，不会有碎片问题，外存利用率高。
- 缺点：**只支持顺序访问，不支持随机访问**，查找效率低，指向下一个盘块的指针也需要耗费少量的存储空间。

四、索引分配

文件离散地分配在各个磁盘块中，系统会为每个文件建立一张索引表，索引表中记录了文

件的各个逻辑块对应的物理块（索引表的功能类似于内存管理中的页表——建立逻辑页面到物理页之间

的映射关系）。索引表存放的磁盘块称为索引块。文件数据存放的磁盘块称为数据块。



若文件太大，单个磁盘块存储不下整张索引表，如何解决？

有三种方案：

- ①**链接方案**：如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放。缺点：若文件很大，索引表很长，就需要将很多个索引块链接起来。想要找到 i 号索引块，必须先依次读入 0~i-1 号索引块，这就导致磁盘I/O次数过多，查找效率低下。 

  ![image-20220314193232419](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141932482.png)

- ②**多层索引**：建立多层索引（原理类似于多级页表）。使第一层索引块指向第二层的索引块。还可根据文件大小的要求再建立第三层、第四层索引块。采用 K 层索引结构，且顶级索引表未调入内存，则访问一个数据块只需要 K + 1 次读磁盘操作。

  缺点：即使是小文件，访问一个数据块依然需要K+1次读磁盘。

  ![image-20220314193219131](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141932185.png)

- ③**混合索引**：多种索引分配方式的结合。例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表）、还包含两级间接索引（指向两层索引表） 。

  优点：对于小文件来说，访问一个数据块所需的读磁盘次数更少。

  ​	![image-20220314193200149](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141932230.png)

 



### 五、文件存储空间管理

一、文件空间的划分和初始化

文件卷

文件区：存放文件数据。

目录区：主要存放文件目录信息（FCB）、用于磁盘存储空间管理的信息

存储空间的初始化：将各个文件卷划分为目录区、文件区

二、文件存储空间管理方法

学习时注意从三个方面进行理解：

- 用什么方式记录、组织空闲块？

- 如何分配磁盘块？

- 如何回收磁盘块？

:one:空闲表法

概述：（适用于连续表法分配方式）

- 磁盘块分配：与内存管理中的动态分区分配很类似，为一个文件分配连续的存储空间。同样**可采用首次适应、最佳适应、最坏适应等算法**来决定要为文件分配哪个区间

- 磁盘块回收：与内存管理中的动态分区分配很类似，当回收某个

  存储区时需要有四种情况

  - ①回收区的前后都没有相邻空闲区；
  - ②回收区的前后都是空闲区；
  - ③回收区前面是空闲区；
  - ④回收区后面是空闲区。总之，**回收时需要注意表项的合并问题。**



:two:空闲链表法

具体如图：

​		![image-20220314194930505](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141949582.png)

- 分配：若某文件申请 K 个盘块，则从链头开始依次摘

  下 K 个盘块分配，并修改空闲链的链头指针。

- 回收：回收的盘块依次挂到链尾，并修改空闲链的链

  尾指针。

适用于离散分配的物理结构。为文件分配多个盘块时可能要重复多次操作

:three:位示图法

​	位示图：每个二进制位对应一个盘块。用0和1来表示盘快是否分配。



​	注意**盘块号与（字号****,** **位号）相互转换的公式：**

​		(字号, 位号)=(i, j) 的二进制位对应的 盘块号 b = ni + j

- 分配：若文件需要K个块，
  - 顺序扫描位示图，找到K个相邻或不相邻的“0”；
  - 根据字号、位号算出对应的盘块号，将相应盘块分配给文件；
  - 将相应位设置为“1”。

- 回收：
  - 根据回收的盘块号计算出对应的字号、位号；
  - 将相应二进制位设为“0” 	

:four:成组链接法

​		空闲表法、空闲链表法不适用于大型文件系统，因为空闲表或空闲链表可能过大。

因此诞生了成组链表法：

​	使用一个专用的磁盘作为**超级块**,指向下一级内存块，每一级内存块的大小都是有限制的。

超级块中包含下一组空闲盘的快数。

​	如图：

![image-20220314195800380](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141958464.png)

### 六、文件的基本操作

​	操作系统向上提供的基本功能：

​		![image-20220314193503323](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141935390.png)

一、创建文件

​	调用Create，需要几个参数：

-  所需的外存空间大小（如：一个盘块，即1KB）

- 文件存放路径（“D:/Demo”）

- 文件名 

Create的流程：

- 在外存中找到文件所需的空间（结合上小节学习的空闲链表法、位示图、成组链接法等管理策略，找到空闲空间）

- 根据文件存放路径的信息找到该目录对应的目录文件（此处就是 D:/Demo 目录），在目录中创建该文件对应的目录项。**目录项中包含了文件名、文件在外存中的存放位置等信息。**

二、删除文件

​	调用Delete，需要提供参数：

- 文件存放路径
- 文件名

Delete的流程：

-  根据文件存放路径找到相应的目录文件，从目录中找到文件名对应的目录项。

- 根据该目录项记录的文件在外存的存放位置、文件大小等信息，回收文件占用的磁盘块。

  （回收磁盘块时，根据空闲表法、空闲链表法、位图法等管理策略的不同，需要做不同的处理）

- 从目录表中删除文件对应的目录项。

三、打开文件

​	在对文件进行操作之前，要求用户先使用 open 系统调用“打开文件”，需要提供的几个主要参数：

- 文件存放路径

- 文件名

- 要对文件的操作类型（如：r 只读；rw 读写等）



open 系统调用：

- 根据文件存放路径找到相应的目录文件，从目录中找到文件名对应的的目录项，并检查该用户是否有指定的操作权限。

- 将目录项复制到内存中的**“打开文件表**”中。并将对应表目的编号返回给用户。之后用户使用打开文件表的编号来指明要操作的文件。

打开文件之后，创建了打开文件表，用户再操作该文件就不需要重新查目录了。加快文件访问速度。

​	![image-20220314194229529](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203141942606.png)

四、关闭文件

​	进程使用完文件后，要“关闭文件”

  Close 系统调用 ：

- 将进程的打开文件表相应表项删除

- 回收分配给该文件的内存空间等资源

- 系统打开文件表的打开计数器count 减1，若 **count = 0，则删除对应表项**。

五、读文件

​	根据读指针、读入数据量、内存位置将文件数据从外存读入内存。

六、写文件

​	根据写指针、写出数据量、内存位置将文件从文件数据从内存写出外存。

### 七、文件共享



文件共享意味着系统中只含有一份文件数据，由多个用户共享。注意和文件复制的区别。

文件共享：为用户提供文件共享功能，可以让多个用户共享地使用同一个文件。

下面是共享文件的两种方式：

一、硬链接

基于索引节点。索引结点中设置一个链接计数变量 count，用于表示链接到本索引结点上的用户目录项数。

若 count = 2，说明此时有两个用户目录项链接到该索引结点上，或者说是有两个用户在共享此文件。若某个用户决定“删除”该文件，则只是要把用户目录中与该文件对应的目录项删除，且索引结点的count值减 1。 

若 count>0，说明还有别的用户要使用该文件，暂时不能把文件数据删除，否则会导致指针悬空。

当 count = 0 时系统负责删除文件。

​	图示：

​	![image-20220314200030859](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203142000927.png)



二、软连接（符号链接）

基于符号链接的共享文件，相当于windows的桌面快捷方式。通过路径引用，定位到文件 。

图示：

![image-20220314200143592](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203142001670.png)



### 八、文件保护

文件保护，是为了保护文件数据的安全。有三种常见方式。

一、口令保护

​	为文件设置一个“口令”（如：abc112233），用户请求访问该文件时必须提供“口令”。

- 优点：保存口令的空间开销不多，验证口令的时间开销也很小。

- 缺点：正确的“口令”存放在系统内部，不够安全。

二、加密保护

​	使用某个“密码”对文件进行加密，在访问文件时需要提供正确的“密码”才能对文件进行正确的解密。

- 优点：保密性强，不需要在系统中存储“密码”
- 缺点：编码/译码，或者说加密/解密要花费一定时间。

三、访问控制

​	在每个文件的FCB（或索引结点）中增加一个访问控制列表（Access-Control List, ACL），该表中记录了各个用户可以对该文件执行哪些操作。

例图：

​		![image-20220314200523812](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203142005887.png)

​	精简的访问列表：（避免用户过多带来的负荷。）

​	系统会按照一定的分类标准 分组。每个组中的成员的权限是相同的。

### 九、文进系统结构层次

​		层次图：

​		![image-20220314200548502](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203142005582.png)

### 十、磁盘

​		![image-20220314200640766](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203142006860.png)

### 十一、磁盘调度算法

1、寻找时间

​	在读/写数据前，将磁头移动到指定磁道所花的时间。

- ①启动磁头臂是需要时间的。假设耗时为 s； 

- ②移动磁头也是需要时间的。假设磁头匀速移动，每跨越一个磁道耗时为 m，总共需要跨越 n 条磁道。则：寻道时间 TS = s + m*n

2、延迟时间

​	通过旋转磁盘，使磁头定位到目标扇区所需要的时间。

​	设磁盘转速为 r （单位：转/秒，或 转/分），则平均所需的延迟时间 

​			TR = (1/2)*(1/r) = 1/(2r)



3、传输时间

​	从磁盘读出或向磁盘写入数据所经历的时间，

​	假设磁盘转速为 r，此次读/写的字节数为 b，每个磁道上的字节数为 N。

​		则：传输时间Tt = (1/r) * (b/N) = b/(rN)

一、先来先服务算法（FCFS）

​	根据进程请求访问磁盘的先后顺序进行调度。

- 优点：公平；如果请求访问的磁道比较集中的话，算法性能还算过的去
- 缺点：近似于随机寻道

二、最短寻找时间算法（SSTF）

​		会优先处理的磁道是与当前磁头最近的磁道。可以保证每次的寻道时间最短，但是并不能保证总的寻道时间最短。（贪心的思想）

- 优点：性能较好，平均寻道时间短

- 缺点：可能产生“饥饿”现象

三、扫描算法（电梯算法）（SCAN）

在SSTF的基础上，规定：只有磁头移动到最外侧磁道的时候才能往内移动，移动到最内侧磁道的时候才能往外移 动。这就是扫描算法（SCAN）的思想

- 优点：性能较好，平均寻道时间较短，不会产生饥饿现象

- 缺点：
  - 只有到达最边上的磁道时才能改变磁头移动方向，事实上，处理了184号磁道的访问请求之后就不需要再往右移动磁头了。
  - SCAN算法对于各个位置磁道的响应频率不平均

四、look算法

​		在SCAN 算法基础上规定：如果在磁头移动方向上已经没有别的请求，就可以立即改变磁头移动方向。

例：	

​		![image-20220314201413868](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203142014944.png)

- 优点：比起 SCAN 算法来，不需要每次都移动到最外侧或最内侧才改变磁头方向，使寻道时间进一步缩短

五、循环扫描算法（C-SCAN ）

​		在SCAN 的基础上：规定只有磁头朝某个特定方向移动时才处理磁道访问请求，而返回时直接快速移动至起始端而不处理任何请求。

- 优点：比起SCAN 来，对于各个位置磁道的响应频率很平均。

- 缺点：只有到达最边上的磁道时才能改变磁头移动方向；比起SCAN算法来，平均寻道时间更长

六、C-look算法

​	C-SCAN 算法的主要缺点是只有到达最边上的磁道时才能改变磁头移动方向，并且磁头返回时不一定需要返回到最边缘的磁道上。C-LOOK 算法就是为了解决这个问题。如果磁头移动的方向上已经没有磁道访问请求了，就可以立即让磁头返回，并且磁头只需要返回到有磁道访问请求的位置即可。

例：

​		![image-20220314201638648](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203142016716.png)

- 优点：比起 C-SCAN 算法来，不需要每次都移动到最外侧或最内侧才改变磁头方向，使寻道时间

进一步缩短

### 十二、磁盘管理

可以认为的减少磁盘寻道的时间（其余两个都和磁盘本身的转速有关）

常见的方法：

 ![image-20220314201722940](https://cdn.jsdelivr.net/gh/chen-boran/Picture_bed/img/202203142017014.png)

​	
